name: Release

on:
  push:
    tags:
      - "v*"

jobs:
  release:
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          # macOS Apple Silicon
          - platform: macos-latest
            target: aarch64-apple-darwin
            brew_prefix: /opt/homebrew
          # macOS Intel
          - platform: macos-latest
            target: x86_64-apple-darwin
            brew_prefix: /usr/local
            arch: x86_64

    runs-on: ${{ matrix.platform }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin,x86_64-apple-darwin

      - name: Install system dependencies (arm64)
        if: ${{ !matrix.arch }}
        run: |
          brew install leptonica tesseract libarchive

      - name: Install system dependencies (x86_64)
        if: ${{ matrix.arch == 'x86_64' }}
        run: |
          # Install x86_64 Homebrew
          arch -x86_64 /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
          arch -x86_64 /usr/local/bin/brew install leptonica tesseract libarchive

      - name: Set environment for x86_64
        if: ${{ matrix.arch == 'x86_64' }}
        run: |
          echo "PKG_CONFIG_PATH=/usr/local/lib/pkgconfig:/usr/local/opt/libarchive/lib/pkgconfig" >> $GITHUB_ENV
          echo "PKG_CONFIG_ALLOW_CROSS=1" >> $GITHUB_ENV
          echo "PKG_CONFIG_SYSROOT_DIR=/" >> $GITHUB_ENV

      - name: Install dependencies
        run: pnpm install

      - name: Copy and patch dylibs for bundling
        run: |
          LIB_MAC_DIR="src-tauri/resources/lib-mac"
          BREW_PREFIX="${{ matrix.brew_prefix }}"

          # Ensure lib-mac directory exists
          mkdir -p "$LIB_MAC_DIR"

          # Copy main libraries
          cp "$BREW_PREFIX/opt/tesseract/lib/libtesseract.5.dylib" "$LIB_MAC_DIR/"
          cp "$BREW_PREFIX/opt/leptonica/lib/libleptonica.6.dylib" "$LIB_MAC_DIR/"
          cp "$BREW_PREFIX/opt/libarchive/lib/libarchive.13.dylib" "$LIB_MAC_DIR/"

          # Run resolve-paths.sh to copy all transitive dependencies and patch paths
          chmod +x ./resolve-paths.sh
          ./resolve-paths.sh "$LIB_MAC_DIR" "$LIB_MAC_DIR"

          # Verify architecture
          echo "Verifying ${{ matrix.target }} architecture:"
          file "$LIB_MAC_DIR"/*.dylib | head -5

      - name: Build and release
        id: tauri
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        with:
          tagName: v__VERSION__
          releaseName: "Snappit v__VERSION__"
          releaseBody: |
            See the assets below to download this version.

            **Installation:**
            - Download the `.dmg` file for your architecture
            - Open and drag Snappit to Applications

            **What's new:**
            - See commit history for changes
          releaseDraft: true
          prerelease: false
          args: --target ${{ matrix.target }}

      - name: Rename release assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RELEASE_ID: ${{ steps.tauri.outputs.releaseId }}
        run: |
          # Determine architecture suffix
          if [[ "${{ matrix.target }}" == "aarch64-apple-darwin" ]]; then
            ARCH_NAME="mac_arm"
          else
            ARCH_NAME="mac_intel"
          fi

          echo "Release ID: $RELEASE_ID"

          # Get and rename only .dmg assets (not .tar.gz - those are referenced by latest.json for auto-updates)
          gh api repos/${{ github.repository }}/releases/$RELEASE_ID/assets --jq '.[] | "\(.id) \(.name)"' | while read -r ASSET_ID ASSET_NAME; do
            NEW_NAME=""

            if [[ "$ASSET_NAME" == *.dmg && "$ASSET_NAME" != *.dmg.sig ]]; then
              NEW_NAME="snappit_${ARCH_NAME}.dmg"
            elif [[ "$ASSET_NAME" == *.dmg.sig ]]; then
              NEW_NAME="snappit_${ARCH_NAME}.dmg.sig"
            fi

            if [[ -n "$NEW_NAME" && "$ASSET_NAME" != "$NEW_NAME" ]]; then
              echo "Renaming $ASSET_NAME -> $NEW_NAME"
              gh api --method PATCH repos/${{ github.repository }}/releases/assets/$ASSET_ID -f name="$NEW_NAME"
            fi
          done
